<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manifesto - Ergodika</title>

  <style>
    :root {
      --col-bg: #faf8fc;
      --col-primary: #7A4FFF;
      --col-accent: #FF6B9A;
      --col-text: #1a1a1a;
      --col-subtle: #767676;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
      background: var(--col-bg);
      color: var(--col-text);
      line-height: 1.6;
      padding: 2rem;
      max-width: 800px;
      margin: 0 auto;
    }

    header {
      border-left: 6px solid var(--col-primary);
      padding-left: 1rem;
      margin-bottom: 2rem;
    }

    h1 {
      font-size: 2rem;
      color: var(--col-primary);
      margin-bottom: 0.2rem;
    }

    h2 {
      color: var(--col-accent);
      margin: 2rem 0 1rem;
    }

    p {
      margin-bottom: 1rem;
    }

    .stats {
      background: white;
      border: 1px solid #e7e7e7;
      border-radius: 12px;
      padding: 1.2rem 1.5rem;
      margin: 2rem 0;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.04);
    }

    .stats.stats--offline {
      opacity: 0.7;
    }

    .stats h3 {
      margin-bottom: .8rem;
      color: var(--col-primary);
    }

    .stat-line {
      display: flex;
      justify-content: space-between;
      margin: .4rem 0;
      font-weight: 500;
    }

    .stats-status {
      margin-top: 1rem;
      font-size: .9rem;
      color: var(--col-subtle);
    }

    .stats--offline .stats-status {
      color: #c0392b;
    }

    button {
      background: linear-gradient(135deg, var(--col-primary), var(--col-accent));
      color: white;
      border: none;
      padding: .8rem 1.5rem;
      border-radius: 30px;
      cursor: pointer;
      font-size: 1rem;
      transition: opacity .25s ease;
    }

    button:hover {
      opacity: 0.85;
    }

    footer {
      text-align: center;
      margin-top: 3rem;
      font-size: .9rem;
      color: var(--col-subtle);
    }
  </style>
</head>

<body>
  <header>
    <h1>Manifesto Ergodika</h1>
    <p>Costruiamo insieme un ecosistema musicale equo, condiviso e sostenibile.</p>
  </header>

  <section>
    <p>
      Ergodika è lo spazio in cui la musica elettronica e contemporanea di Roma trova
      una voce condivisa.
      Ogni donazione e ogni abbonamento sostengono direttamente gli artisti e
      alimentano un circuito musicale indipendente, trasparente e aperto.
    </p>
  </section>

  <section class="stats">
    <h3>Trasparenza in tempo reale</h3>
    <div class="stat-line">
      <span>Donazioni completate</span>
      <span id="counter-donations">–</span>
    </div>
    <div class="stat-line">
      <span>Abbonamenti attivi</span>
      <span id="counter-subs">–</span>
    </div>
    <div class="stat-line">
      <span>Ultimo aggiornamento</span>
      <span id="counter-last">–</span>
    </div>
    <p class="stats-status" id="counter-status">Aggiornamento in corso…</p>
  </section>

  <section>
    <button data-donate data-amount="100" data-artist="test-artist-001">Dona 1 €</button>
    <button data-sub-tier="3" data-price-key="sub_basic">Abbonati 3 €/mese</button>
    <button data-sub-tier="7" data-price-key="sub_plus">Abbonati 7 €/mese</button>

  </section>

  <footer>
    © Ergodika — Roma · Musica e condivisione senza confini
  </footer>

  <script src="/assets/js/payments.js"></script>
  <script>
    const PAGE_HOST = String(window.location.hostname || "").toLowerCase();
    const LIKELY_LOCAL_HOST = !PAGE_HOST
      || PAGE_HOST === "localhost"
      || PAGE_HOST === "127.0.0.1"
      || PAGE_HOST === "0.0.0.0"
      || PAGE_HOST.endsWith(".local");

    const DEFAULT_WORKER_BASE = (() => {
      if (LIKELY_LOCAL_HOST) return "/api";
      if (PAGE_HOST === "www.ergodika.it" || PAGE_HOST === "ergodika.it") {
        return "https://api.ergodika.it/api";
      }
      if (PAGE_HOST.endsWith(".ergodika.it") && PAGE_HOST !== "api.ergodika.it") {
        return "https://api.ergodika.it/api";
      }
      return "/api";
    })();

    const FALLBACK_WORKER_BASE = DEFAULT_WORKER_BASE;
    let workerBasePromise = null;
    let countersTimer = null;
    let countersDisabled = false;

    async function resolveWorkerBase() {
      if (!workerBasePromise) {
        workerBasePromise = (async () => {
          try {
            if (window.ErgodikaPayments?.ready) {
              await window.ErgodikaPayments.ready();
              const base = window.ErgodikaPayments.workerBase;
              if (base) return base;
            }
          } catch (err) {
            console.warn("[Manifesto] Payments config unavailable:", err?.message || err);
          }

          try {
            const res = await fetch("/config/app.json", { cache: "no-store" });
            if (res.ok) {
              const cfg = await res.json();
              const base = String(cfg?.stripe?.workerBase || cfg?.workerBase || FALLBACK_WORKER_BASE)
                .replace(/\/$/, "");
              if (base) {
                if (LIKELY_LOCAL_HOST && /^https?:/i.test(base) && FALLBACK_WORKER_BASE.startsWith("/")) {
                  console.info("[Manifesto] Ignoro worker remoto in ambiente locale.");
                  return FALLBACK_WORKER_BASE;
                }
                return base || FALLBACK_WORKER_BASE;
              }
            } else {
              console.warn("[Manifesto] Config HTTP", res.status);
            }
          } catch (err) {
            console.warn("[Manifesto] Config fetch failed:", err?.message || err);
          }

          return FALLBACK_WORKER_BASE;
        })();
      }

      return workerBasePromise;
    }

    function disableCounters(reason) {
      if (countersDisabled) return;
      countersDisabled = true;
      if (countersTimer) {
        clearInterval(countersTimer);
        countersTimer = null;
      }
      const statsBox = document.querySelector(".stats");
      if (statsBox) statsBox.classList.add("stats--offline");
      const statusEl = document.getElementById("counter-status");
      if (statusEl) statusEl.textContent = reason || "Contatori non disponibili in questo ambiente.";
    }

    async function getCounters() {
      const statusEl = document.getElementById("counter-status");
      if (statusEl && !countersDisabled) {
        statusEl.textContent = "Aggiornamento in corso…";
      }
      try {
        const WORKER_BASE = await resolveWorkerBase();
        const res = await fetch(WORKER_BASE + "/debug-counters", {
          cache: "no-store"
        });
        if (res.status === 404) {
          console.info("[Manifesto] Contatori non disponibili (404). Disabilito aggiornamenti.");
          disableCounters("Contatori non disponibili in questo ambiente.");
          return;
        }
        if (!res.ok) {
          const error = new Error("HTTP " + res.status);
          error.status = res.status;
          throw error;
        }
        const data = await res.json();
        document.getElementById("counter-donations").textContent = data["payments:count"] || "0";
        document.getElementById("counter-subs").textContent = data["subs:paid"] || "0";
        document.getElementById("counter-last").textContent = new Date().toLocaleTimeString();
        if (statusEl) {
          statusEl.textContent = "Aggiornato alle " + new Date().toLocaleTimeString();
        }
      } catch (e) {
        if (countersDisabled) return;
        if (statusEl) {
          statusEl.textContent = "Aggiornamento non riuscito. Riprovo tra poco.";
        }
        console.warn("Counters fetch failed", e);
        if ((e && e.name === "TypeError") || /failed to fetch/i.test(String(e && e.message))) {
          disableCounters("Contatori non disponibili in questo ambiente.");
        }
      }
    }

    async function donate(amount) {
      try {
        const WORKER_BASE = await resolveWorkerBase();
        const res = await fetch(WORKER_BASE + "/checkout/one-time", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            amount,
            artistId: "demo",
            memo: "Supporto Ergodika"
          })
        });
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        const data = await res.json();
        if (data.url) window.location.href = data.url;
        else alert("Errore: " + (data.error || "imprevisto"));
      } catch (e) {
        alert(e?.message ? ("Connessione non riuscita: " + e.message) : "Connessione non riuscita");
      }
    }

    async function subscribe() {
      // imposta qui il tuo priceId da Stripe
      const priceId = "price_1SEy51RrORapViImXAr4Lmae";
      try {
        const WORKER_BASE = await resolveWorkerBase();
        const res = await fetch(WORKER_BASE + "/checkout/subscription", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            priceId,
            memo: "Abbonamento Ergodika"
          })
        });
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        const data = await res.json();
        if (data.url) window.location.href = data.url;
        else alert("Errore: " + (data.error || "imprevisto"));
      } catch (e) {
        alert(e?.message ? ("Connessione non riuscita: " + e.message) : "Connessione non riuscita");
      }
    }

    window.addEventListener("load", () => {
      void getCounters();
      countersTimer = setInterval(() => {
        if (!countersDisabled) void getCounters();
      }, 20000);
    });
  </script>
</body>

</html>
