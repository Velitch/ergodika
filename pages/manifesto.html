<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manifesto - Ergodika</title>

  <style>
    :root {
      --col-bg: #faf8fc;
      --col-primary: #7A4FFF;
      --col-accent: #FF6B9A;
      --col-text: #1a1a1a;
      --col-subtle: #767676;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
      background: var(--col-bg);
      color: var(--col-text);
      line-height: 1.6;
      padding: 2rem;
      max-width: 800px;
      margin: 0 auto;
    }

    header {
      border-left: 6px solid var(--col-primary);
      padding-left: 1rem;
      margin-bottom: 2rem;
    }

    h1 {
      font-size: 2rem;
      color: var(--col-primary);
      margin-bottom: 0.2rem;
    }

    h2 { color: var(--col-accent); margin: 2rem 0 1rem; }

    p { margin-bottom: 1rem; }

    .stats {
      background: white;
      border: 1px solid #e7e7e7;
      border-radius: 12px;
      padding: 1.2rem 1.5rem;
      margin: 2rem 0;
      box-shadow: 0 4px 8px rgba(0,0,0,0.04);
    }

    .stats h3 { margin-bottom: .8rem; color: var(--col-primary); }

    .stat-line {
      display: flex;
      justify-content: space-between;
      margin: .4rem 0;
      font-weight: 500;
    }

    button {
      background: linear-gradient(135deg, var(--col-primary), var(--col-accent));
      color: white;
      border: none;
      padding: .8rem 1.5rem;
      border-radius: 30px;
      cursor: pointer;
      font-size: 1rem;
      transition: opacity .25s ease;
    }

    button:hover { opacity: 0.85; }

    footer {
      text-align: center;
      margin-top: 3rem;
      font-size: .9rem;
      color: var(--col-subtle);
    }
  </style>
</head>

<body>
  <header>
    <h1>Manifesto Ergodika</h1>
    <p>Costruiamo insieme un ecosistema musicale equo, condiviso e sostenibile.</p>
  </header>

  <section>
    <p>
      Ergodika è lo spazio in cui la musica elettronica e contemporanea di Roma trova
      una voce condivisa.
      Ogni donazione e ogni abbonamento sostengono direttamente gli artisti e
      alimentano un circuito musicale indipendente, trasparente e aperto.
    </p>
  </section>

  <section class="stats">
    <h3>Trasparenza in tempo reale</h3>
    <div class="stat-line">
      <span>Donazioni completate</span>
      <span id="counter-donations">–</span>
    </div>
    <div class="stat-line">
      <span>Abbonamenti attivi</span>
      <span id="counter-subs">–</span>
    </div>
    <div class="stat-line">
      <span>Ultimo aggiornamento</span>
      <span id="counter-last">–</span>
    </div>
  </section>

  <section>
    <button onclick="donate(1)">Dona 1 €</button>
    <button onclick="subscribe()">Abbonati</button>
  </section>

  <footer>
    © Ergodika — Roma · Musica e condivisione senza confini
  </footer>

  <script>
    const WORKER_BASE = "https://ergodika-api.ergodika.workers.dev";

    async function getCounters() {
      try {
        const res = await fetch(WORKER_BASE + "/api/debug-counters", { cache: "no-store" });
        const data = await res.json();
        document.getElementById("counter-donations").textContent = data["payments:count"] || "0";
        document.getElementById("counter-subs").textContent = data["subs:paid"] || "0";
        document.getElementById("counter-last").textContent = new Date().toLocaleTimeString();
      } catch (e) {
        console.warn("Counters fetch failed", e);
      }
    }

    async function donate(amount) {
      try {
        const res = await fetch(WORKER_BASE + "/api/checkout/one-time", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount, artistId: "demo", memo: "Supporto Ergodika" })
        });
        const data = await res.json();
        if (data.url) window.location.href = data.url;
        else alert("Errore: " + (data.error || "imprevisto"));
      } catch (e) { alert("Connessione non riuscita"); }
    }

    async function subscribe() {
      // imposta qui il tuo priceId da Stripe
      const priceId = "price_1SEy51RrORapViImXAr4Lmae";
      try {
        const res = await fetch(WORKER_BASE + "/api/checkout/subscription", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ priceId, memo: "Abbonamento Ergodika" })
        });
        const data = await res.json();
        if (data.url) window.location.href = data.url;
        else alert("Errore: " + (data.error || "imprevisto"));
      } catch (e) { alert("Connessione non riuscita"); }
    }

    window.addEventListener("load", () => {
      getCounters();
      setInterval(getCounters, 20000);
    });
  </script>
</body>
</html>
